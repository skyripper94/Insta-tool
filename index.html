<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>NeuroStep Redactor — MVP</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Fabric.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <!-- Иконки -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;800&family=Poppins:wght@400;700&family=Roboto:wght@400;700;900&family=Oswald:wght@400;700&family=Raleway:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0f1220; --panel:#151a2e; --panel-2:#0e1326; --text:#e8ecff; --muted:#a0a8c8;
      --accent:#6ae1ff; --accent-2:#9b6bff; --danger:#ff5d7a; --ok:#42d392; --line:#222744;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:linear-gradient(180deg,#0c1124 0%,#0a0f20 100%); color:var(--text);
      font:14px/1.35 "Montserrat",system-ui,-apple-system,Segoe UI,Roboto,Arial;
      display:flex; gap:12px; padding:12px; overflow:hidden;
    }
    /* ЛЕВЫЙ САЙДБАР */
    aside{
      width:360px; min-width:320px; max-width:420px; overflow:auto; padding:12px; border:1px solid var(--line);
      background:linear-gradient(180deg,var(--panel) 0%,var(--panel-2) 100%); border-radius:12px;
      box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    h1{font-size:16px; margin:0 0 10px; letter-spacing:.4px}
    h2{font-size:13px; margin:16px 0 8px; color:var(--muted); font-weight:600; text-transform:uppercase}
    .row{display:flex; gap:8px; margin:8px 0}
    .col{display:flex; flex-direction:column; gap:8px}
    .btn, button, label.btn{
      display:inline-flex; align-items:center; justify-content:center; gap:6px;
      padding:8px 10px; border:1px solid var(--line); background:#0b1123; color:var(--text);
      border-radius:8px; cursor:pointer; user-select:none; transition:.15s ease;
    }
    .btn:hover{border-color:#334; transform:translateY(-1px)}
    .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#0a0d1d; font-weight:800; letter-spacing:.3px}
    .btn.danger{background:#2a0f16; border-color:#4e1c28; color:#ffc9d5}
    .btn.ghost{background:transparent}
    .btn.toggle.active, .chip.active{outline:2px solid var(--accent)}
    .chip{
      padding:6px 8px; border:1px dashed var(--line); border-radius:6px; cursor:pointer; color:var(--muted);
    }
    input[type="file"]{display:none}
    select, input[type="number"], input[type="text"], input[type="range"]{
      width:100%; background:#0b1123; border:1px solid var(--line); color:var(--text); border-radius:8px; padding:8px;
    }
    input[type="range"]{padding:0; height:32px}
    .hint{color:var(--muted); font-size:12px}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:8px}
    .sep{height:1px; background:linear-gradient(90deg,transparent,#2b3152,transparent); margin:12px 0}
    .kbar{display:flex; gap:8px; flex-wrap:wrap}
    .kbar .btn{flex:1}
    /* ПРАВАЯ ЧАСТЬ: КАНВАС + ПАНЕЛЬ СЛОЁВ */
    main{display:flex; gap:12px; flex:1; min-width:0}
    .stage{
      flex:1; min-width:0; display:flex; flex-direction:column; gap:8px; align-items:center; justify-content:center;
      border:1px solid var(--line); border-radius:12px; background:radial-gradient(60% 60% at 50% 40%,#131838 0%,#0a0f22 100%);
      position:relative; box-shadow:inset 0 0 0 1px rgba(255,255,255,.02);
    }
    canvas{background:#111728; border-radius:10px}
    .format-bar{position:absolute; top:8px; left:8px; display:flex; gap:8px; z-index:5}
    .format-bar .btn{padding:6px 10px}
    .slides{
      width:320px; min-width:280px; border:1px solid var(--line); background:linear-gradient(180deg,var(--panel) 0%,var(--panel-2) 100%);
      border-radius:12px; padding:12px; overflow:auto; box-shadow:0 10px 30px rgba(0,0,0,.35);
    }
    .slides .slide-item{
      border:1px solid var(--line); border-radius:8px; padding:8px; margin-bottom:8px; display:flex; align-items:center; gap:8px;
      cursor:pointer; background:#0b1123;
    }
    .slides .slide-item.active{outline:2px solid var(--accent)}
    .thumb{width:56px; height:56px; background:#161a2c; border:1px solid #222640; border-radius:6px; flex:0 0 56px; display:flex; align-items:center; justify-content:center; font-size:11px; color:#7f88b0}
    .layers{max-height:300px; overflow:auto; border:1px dashed #283052; border-radius:8px; padding:8px}
    .layer-row{display:grid; grid-template-columns:auto 1fr auto auto; gap:6px; padding:6px; border-radius:6px; align-items:center}
    .layer-row:hover{background:#0b1123}
    .layer-row .handle{cursor:grab; color:#6f78a1}
    .badge{font-size:11px; color:#9fb4ff; background:#0e1734; border:1px solid #24305d; padding:2px 6px; border-radius:999px}
    .tiny{font-size:11px; color:#8da0d1}
    .footer{display:flex; gap:8px; justify-content:space-between; align-items:center; width:100%; padding:8px}
  </style>
</head>
<body>
  <!-- ЛЕВАЯ ПАНЕЛЬ: Управление -->
  <aside>
    <h1>NeuroStep Redactor — MVP</h1>
    <div class="hint">Браузерный редактор для постов, каруселей и сторис. Fabric.js + MediaRecorder.</div>

    <div class="sep"></div>
    <h2>Формат холста</h2>
    <div class="grid">
      <button class="btn" data-format="1080x1080">1080×1080</button>
      <button class="btn" data-format="1080x1350">1080×1350</button>
      <button class="btn" data-format="1080x1920">1080×1920</button>
    </div>

    <div class="sep"></div>
    <h2>Фон / Градиент / Картинки</h2>
    <div class="row">
      <label class="btn"><input id="bgFile" type="file" accept="image/*">Загрузить фон</label>
      <button id="bgColorBtn" class="btn">Цвет фона</button>
    </div>
    <div class="row">
      <select id="gradientPreset">
        <option value="none">Градиент: нет</option>
        <option value="black-up">Чёрный→прозрачный (вверх)</option>
        <option value="black-down">Чёрный→прозрачный (вниз)</option>
        <option value="gray-darkgray">Серый→тёмно-серый</option>
        <option value="black-gray-transp">Чёрный→серый→прозрачный</option>
      </select>
      <button id="gradientAboveBtn" class="btn toggle">Градиент над картинкой</button>
    </div>
    <div class="row">
      <label class="btn"><input id="mainImgFile" type="file" accept="image/*">Основная картинка</label>
      <label class="btn"><input id="pngFile" type="file" multiple accept="image/png,image/webp">Добавить PNG</label>
    </div>

    <div class="sep"></div>
    <h2>Текст</h2>
    <div class="grid">
      <button id="addTitle" class="btn">+ Заголовок</button>
      <button id="addCaption" class="btn">+ Caption</button>
    </div>
    <div class="row">
      <select id="fontFamily">
        <option>Montserrat</option>
        <option>Poppins</option>
        <option>Roboto</option>
        <option>Oswald</option>
        <option>Raleway</option>
      </select>
      <select id="fontColor">
        <option value="#ffffff">Белый</option>
        <option value="#000000">Чёрный</option>
        <option value="#ffd400">Жёлтый</option>
      </select>
    </div>
    <div class="row">
      <input id="textSize" type="range" min="16" max="160" value="64" />
    </div>
    <div class="row">
      <div class="chip" data-preset="bold-shadow">Bold white + чёрная тень</div>
      <div class="chip" data-preset="yellow-glow">Жёлтый glow</div>
      <div class="chip" data-preset="minimal-black">Минималистичный чёрный</div>
      <div class="chip" data-preset="white-soft">Белый soft shadow</div>
    </div>
    <div class="row">
      <label>Ширина блока текста (% от холста)</label>
      <input id="textWidthPct" type="range" min="20" max="100" value="80" />
    </div>

    <div class="sep"></div>
    <h2>Безопасные зоны / Сетка</h2>
    <div class="row">
      <button id="toggleSafe" class="btn toggle">Safe-zones</button>
      <button id="toggleGrid" class="btn toggle">Сетка 3×3</button>
    </div>

    <div class="sep"></div>
    <h2>Брендинг (лого)</h2>
    <div class="row">
      <label class="btn"><input id="logoFile" type="file" accept="image/png,image/webp">Загрузить PNG-лого</label>
      <button id="logoPop" class="btn">Pop-up</button>
    </div>

    <div class="sep"></div>
    <h2>Эффекты</h2>
    <div class="tiny">Текст (применяются к выделенному тексту)</div>
    <div class="kbar">
      <button class="btn toggle effBtn" data-eff="text-fade">Fade in/out</button>
      <button class="btn toggle effBtn" data-eff="text-pulse">Pulse</button>
      <button class="btn toggle effBtn" data-eff="text-slide">Slide-in (caption)</button>
    </div>
    <div class="tiny" style="margin-top:6px">PNG-объекты (к выделенному объекту)</div>
    <div class="kbar">
      <button class="btn toggle effBtn" data-eff="obj-parallax">Parallax drift</button>
      <button class="btn toggle effBtn" data-eff="obj-float">Float</button>
      <button class="btn toggle effBtn" data-eff="obj-zoom">Soft zoom</button>
    </div>

    <div class="sep"></div>
    <h2>История / Порядок</h2>
    <div class="grid">
      <button id="undoBtn" class="btn">↶ Undo</button>
      <button id="redoBtn" class="btn">↷ Redo</button>
    </div>
    <div class="row">
      <div class="layers" id="layers"></div>
    </div>
    <div class="row">
      <button id="bringFront" class="btn">На передний план</button>
      <button id="sendBack" class="btn">Отправить назад</button>
    </div>

    <div class="sep"></div>
    <h2>Экспорт</h2>
    <div class="row">
      <button id="exportPNG" class="btn primary">Экспорт PNG</button>
    </div>
    <div class="row">
      <input id="durationSec" type="number" min="3" max="15" value="8" />
      <button id="exportWebM" class="btn primary">Экспорт WebM (анимация)</button>
    </div>
    <div class="hint">MP4 — конвертируй WebM внешним инструментом (ffmpeg/онлайн).</div>
    <div class="sep"></div>

    <div class="footer">
      <div class="tiny">MVP • Fabric.js • v0.9</div>
      <div class="tiny">© NeuroStep</div>
    </div>
  </aside>

  <!-- СЦЕНА -->
  <main>
    <div class="stage">
      <div class="format-bar">
        <span class="badge" id="formatBadge">1080×1350</span>
      </div>
      <canvas id="cvs"></canvas>
    </div>

    <!-- Слайды -->
    <section class="slides">
      <h2>Слайды (карусель)</h2>
      <div class="row">
        <button id="addSlide" class="btn">+ Слайд</button>
        <button id="dupSlide" class="btn">Дублировать</button>
        <button id="copyPrev" class="btn">Скопировать слои со 2го</button>
      </div>
      <div id="slidesList"></div>
      <div class="sep"></div>
      <div class="row">
        <button id="prevSlide" class="btn">← Пред</button>
        <button id="nextSlide" class="btn">След →</button>
      </div>
    </section>
  </main>

<script>
/* ==============================
   NeuroStep Redactor — Core
   ============================== */

/** Состояние приложения */
const App = {
  canvas: null,
  W:1080, H:1350, dpi:1,
  slides: [],           // [{json:string, thumb:ImageDataURL, history:[], redo:[]}]
  currentSlide: 0,
  safeLayer: null,      // группы overlay
  gridLayer: null,
  gradientLayer: null,
  mainImage: null,
  logoObj: null,
  titleObj: null,
  captionObj: null,
  animClock: 0,
  isRecording: false,
  lastSaveTs: 0
};

/** Инициализация */
function init(){
  const el = document.getElementById('cvs');
  App.canvas = new fabric.Canvas(el, {
    backgroundColor: '#101427',
    preserveObjectStacking:true,
    selection:true
  });
  fabric.Object.prototype.transparentCorners = false;
  fabric.Object.prototype.cornerColor = '#6ae1ff';
  fabric.Object.prototype.cornerStyle = 'circle';
  fabric.Object.prototype.borderColor = '#6ae1ff';
  fabric.Object.prototype.cornerSize = 10;

  setFormat(1080,1350);
  createOverlays();
  bindUI();
  newSlide(true); // слайд 0
  tick(); // анимация
}

/* ---------- Формат / Масштаб ---------- */
function setFormat(w,h){
  App.W=w; App.H=h;
  App.canvas.setWidth(w); App.canvas.setHeight(h);
  document.getElementById('formatBadge').textContent = `${w}×${h}`;
  App.canvas.renderAll();
  updateThumb();
}

/** Масштаб всех объектов при смене формата */
function scaleToFormat(newW,newH){
  const sX = newW / App.W, sY = newH / App.H;
  App.canvas.getObjects().forEach(o=>{
    if(o.excludeFromExport) return; // оверлеи пересчитаем отдельно
    o.scaleX *= sX; o.scaleY *= sY;
    o.left *= sX; o.top *= sY; o.setCoords();
  });
  setFormat(newW,newH);
  rebuildOverlays();
  pushHistory();
}

/* ---------- Слайдер ---------- */
function newSlide(initial=false){
  const json = App.canvas.toJSON(['nsType','nsEffect','excludeFromExport']);
  if(!initial){ // сохранить текущий
    App.slides[App.currentSlide].json = JSON.stringify(json);
    App.slides[App.currentSlide].thumb = App.canvas.toDataURL({format:'png',multiplier:0.2});
  }
  // создать новый
  const slide = { json: JSON.stringify(blankState()), thumb:null, history:[], redo:[] };
  App.slides.push(slide);
  App.currentSlide = App.slides.length-1;
  loadSlide(App.currentSlide);
  renderSlides();
}
function dupCurrentSlide(){
  const cur = App.slides[App.currentSlide];
  const copy = { json: cur.json, thumb:cur.thumb, history:[], redo:[] };
  App.slides.splice(App.currentSlide+1, 0, copy);
  App.currentSlide++;
  loadSlide(App.currentSlide);
  renderSlides();
}
function copyFromPrev(){
  if(App.currentSlide===0) return;
  const prev = App.slides[App.currentSlide-1];
  App.slides[App.currentSlide].json = prev.json;
  loadSlide(App.currentSlide);
}
function prevSlide(){ if(App.currentSlide>0){ saveCurrent(); App.currentSlide--; loadSlide(App.currentSlide); renderSlides(); } }
function nextSlide(){ if(App.currentSlide<App.slides.length-1){ saveCurrent(); App.currentSlide++; loadSlide(App.currentSlide); renderSlides(); } }
function loadSlide(idx){
  App.canvas.offRender = true; // минимизировать лишние renderAll
  App.canvas.clear();
  createOverlays();
  const data = JSON.parse(App.slides[idx].json);
  App.canvas.loadFromJSON(data, ()=>{
    // восстановим ссылки на ключевые объекты
    App.gradientLayer = App.canvas.getObjects().find(o=>o.nsType==='gradient')||null;
    App.mainImage = App.canvas.getObjects().find(o=>o.nsType==='mainImage')||null;
    App.titleObj = App.canvas.getObjects().find(o=>o.nsType==='title')||null;
    App.captionObj = App.canvas.getObjects().find(o=>o.nsType==='caption')||null;
    App.logoObj = App.canvas.getObjects().find(o=>o.nsType==='logo')||null;
    App.canvas.renderAll();
    App.canvas.offRender = false;
    buildLayerList();
    pushHistory(true);
  });
}
function saveCurrent(){
  App.slides[App.currentSlide].json = JSON.stringify(App.canvas.toJSON(['nsType','nsEffect','excludeFromExport']));
  App.slides[App.currentSlide].thumb = App.canvas.toDataURL({format:'png',multiplier:0.2});
}

/* ---------- Базовое пустое состояние ---------- */
function blankState(){
  // Пустой слой-заглушка, всё остальное добавляет пользователь
  const objs = [];
  return { version: App.canvas.version, objects: objs, background: App.canvas.backgroundColor };
}

/* ---------- Оверлеи: Safe-zones + Grid ---------- */
function createOverlays(){
  // Safe-zones
  const topH = App.H>=1800 ? 260 : (App.H>=1300? 160 : 120);
  const botH = topH;
  const top = new fabric.Rect({ left:0, top:0, width:App.W, height:topH, fill:'rgba(255,0,0,.08)', selectable:false, evented:false, excludeFromExport:true });
  const bot = new fabric.Rect({ left:0, top:App.H-botH, width:App.W, height:botH, fill:'rgba(255,0,0,.08)', selectable:false, evented:false, excludeFromExport:true });
  const sg = new fabric.Group([top,bot], { selectable:false, evented:false });
  sg.excludeFromExport = true; sg.nsType='safe';
  App.safeLayer = sg; App.canvas.add(sg); App.safeLayer.visible=false;

  // Grid 3x3
  const lines = [];
  for(let i=1;i<3;i++){
    lines.push(new fabric.Line([App.W/3*i,0,App.W/3*i,App.H],{stroke:'rgba(255,255,255,.12)', selectable:false, evented:false, strokeWidth:1}));
    lines.push(new fabric.Line([0,App.H/3*i,App.W,App.H/3*i],{stroke:'rgba(255,255,255,.12)', selectable:false, evented:false, strokeWidth:1}));
  }
  const gg = new fabric.Group(lines,{selectable:false,evented:false});
  gg.excludeFromExport=true; gg.nsType='grid';
  App.gridLayer = gg; App.canvas.add(gg); App.gridLayer.visible=false;
}
function rebuildOverlays(){
  // удалить и создать заново под новый размер
  if(App.safeLayer) App.canvas.remove(App.safeLayer);
  if(App.gridLayer) App.canvas.remove(App.gridLayer);
  createOverlays();
  App.canvas.renderAll();
}

/* ---------- Градиенты ---------- */
function applyGradient(preset, above=false){
  // создаём/обновляем прямоугольник на весь холст
  if(!App.gradientLayer){
    App.gradientLayer = new fabric.Rect({ left:0, top:0, width:App.W, height:App.H, selectable:false, evented:false, opacity:1 });
    App.gradientLayer.nsType='gradient';
    App.canvas.add(App.gradientLayer);
  } else {
    App.gradientLayer.set({ width:App.W, height:App.H, left:0, top:0 });
  }
  if(preset==='none'){
    App.gradientLayer.visible=false;
  } else {
    App.gradientLayer.visible=true;
    const stops = getGradientStops(preset);
    const grad = new fabric.Gradient({
      type:'linear',
      gradientUnits:'pixels',
      coords:{ x1:0, y1: above?App.H:0, x2:0, y2: above?0:App.H },
      colorStops: stops
    });
    App.gradientLayer.set('fill',grad);
  }
  if(above) App.canvas.bringToFront(App.gradientLayer);
  else App.canvas.sendToBack(App.gradientLayer);
  // но фон (backgroundColor) остаётся самым низким
  App.canvas.renderAll();
  buildLayerList();
  pushHistory();
}
function getGradientStops(preset){
  switch(preset){
    case 'black-up': return [{offset:0,color:'rgba(0,0,0,0.85)'},{offset:1,color:'rgba(0,0,0,0)'}];
    case 'black-down': return [{offset:0,color:'rgba(0,0,0,0)'},{offset:1,color:'rgba(0,0,0,0.85)'}];
    case 'gray-darkgray': return [{offset:0,color:'#3c4452'},{offset:1,color:'#181b24'}];
    case 'black-gray-transp': return [{offset:0,color:'rgba(0,0,0,.85)'},{offset:.6,color:'rgba(80,80,80,.6)'},{offset:1,color:'rgba(0,0,0,0)'}];
    default: return [{offset:0,color:'rgba(0,0,0,0)'},{offset:1,color:'rgba(0,0,0,0)'}];
  }
}

/* ---------- Загрузка изображений ---------- */
function readAsDataURL(file){ return new Promise(res=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.readAsDataURL(file); }); }
async function loadBackground(file){
  const url = await readAsDataURL(file);
  fabric.Image.fromURL(url, img=>{
    // фон как backgroundImage, растягиваем под холст
    img.set({ originX:'left', originY:'top' });
    const s = Math.max(App.W/img.width, App.H/img.height);
    img.scale(s);
    App.canvas.setBackgroundImage(img, App.canvas.renderAll.bind(App.canvas));
    pushHistory();
  }, { crossOrigin:'anonymous' });
}
async function loadMainImage(file){
  const url = await readAsDataURL(file);
  fabric.Image.fromURL(url, img=>{
    const s = Math.min(App.W*0.8/img.width, App.H*0.8/img.height);
    img.scale(s);
    img.set({ left:App.W/2, top:App.H/2, originX:'center', originY:'center' });
    img.set({ borderColor:'#6ae1ff', cornerColor:'#6ae1ff' });
    img.nsType='mainImage';
    if(App.mainImage){ App.canvas.remove(App.mainImage); }
    App.mainImage = img; App.canvas.add(img);
    buildLayerList();
    App.canvas.setActiveObject(img);
    App.canvas.renderAll();
    pushHistory();
  }, { crossOrigin:'anonymous' });
}
async function addPngObjects(files){
  for(const f of files){
    const url = await readAsDataURL(f);
    await new Promise(res=>{
      fabric.Image.fromURL(url, img=>{
        const s = Math.min(400/img.width, 400/img.height);
        img.scale(Math.min(1,s));
        img.set({ left:App.W*0.5 + (Math.random()*80-40), top:App.H*0.5 + (Math.random()*80-40), originX:'center', originY:'center' });
        img.nsType='png';
        App.canvas.add(img);
        res();
      }, { crossOrigin:'anonymous' });
    });
  }
  buildLayerList();
  App.canvas.renderAll();
  pushHistory();
}
async function loadLogo(file){
  const url = await readAsDataURL(file);
  fabric.Image.fromURL(url, img=>{
    const s = 180/Math.max(img.width,img.height);
    img.scale(s);
    img.set({ left:App.W-60, top:App.H-60, originX:'right', originY:'bottom', opacity:.5 });
    img.nsType='logo';
    if(App.logoObj) App.canvas.remove(App.logoObj);
    App.logoObj = img; App.canvas.add(img); App.canvas.bringToFront(img);
    App.canvas.renderAll();
    pushHistory();
    logoPop();
  }, { crossOrigin:'anonymous' });
}

/* ---------- Текст ---------- */
function addTitle(){
  const tb = new fabric.Textbox("Заголовок", {
    left: App.W/2, top: App.H*0.2, originX:'center', originY:'center',
    width: App.W*0.8, fontFamily:getFont(), fontWeight:800, fontSize:64, fill:'#ffffff',
    editable:true, splitByGrapheme:true
  });
  tb.nsType='title';
  App.titleObj = tb; App.canvas.add(tb); App.canvas.bringToFront(tb);
  fitText(tb);
  App.canvas.setActiveObject(tb); App.canvas.renderAll(); pushHistory();
}
function addCaption(){
  const tb = new fabric.Textbox("Caption текст. Можете редактировать и переносы строк будут по ширине блока.", {
    left: App.W/2, top: App.H*0.8, originX:'center', originY:'center',
    width: App.W*0.85, fontFamily:getFont(), fontWeight:600, fontSize:38, fill:'#ffffff',
    editable:true, splitByGrapheme:true
  });
  tb.nsType='caption';
  App.captionObj = tb; App.canvas.add(tb); App.canvas.bringToFront(tb);
  fitText(tb);
  App.canvas.setActiveObject(tb); App.canvas.renderAll(); pushHistory();
}
function getFont(){ return document.getElementById('fontFamily').value; }
function applyTextProps(){
  const o = App.canvas.getActiveObject();
  if(!o || !o.isType('textbox')) return;
  o.set({ fontFamily:getFont(), fill: document.getElementById('fontColor').value, fontSize: +document.getElementById('textSize').value });
  fitText(o);
  App.canvas.renderAll(); pushHistory();
}
function fitText(tb){
  // Автоуменьшение размера если выходит за границы высоты и ширины
  if(!tb || !tb.width) return;
  const maxW = tb.width, maxH = (tb.nsType==='title')? App.H*0.28 : App.H*0.28;
  let fs = tb.fontSize || 48;
  tb.set({ fontSize: fs });
  let bounds = tb.getBoundingRect(true,true);
  while((bounds.width>maxW || bounds.height>maxH) && fs>14){
    fs -= 1; tb.set({ fontSize:fs }); bounds = tb.getBoundingRect(true,true);
  }
}
function applyTextPreset(p){
  const o = App.canvas.getActiveObject();
  if(!o || !o.isType('textbox')) return;
  // сброс теней
  o.set('shadow', null);
  switch(p){
    case 'bold-shadow':
      o.set({ fill:'#ffffff', fontWeight:900, shadow:'rgba(0,0,0,0.95) 0px 3px 12px' });
      break;
    case 'yellow-glow':
      o.set({ fill:'#ffd400', fontWeight:800, shadow:'rgba(255,212,0,0.55) 0 0 24px' });
      break;
    case 'minimal-black':
      o.set({ fill:'#000000', fontWeight:700, shadow:null });
      break;
    case 'white-soft':
      o.set({ fill:'#ffffff', fontWeight:700, shadow:'rgba(0,0,0,0.35) 0 2px 8px' });
      break;
  }
  fitText(o);
  App.canvas.renderAll(); pushHistory();
}

/* ---------- Эффекты ---------- */
function toggleEffect(kind){
  const o = App.canvas.getActiveObject();
  if(!o) return;
  o.nsEffect = o.nsEffect || {};
  // Эффекты текст/объекты различаем по kind
  if(kind.startsWith('text') && !o.isType('textbox')) return;
  if(kind.startsWith('obj') && o.isType('textbox')) return;

  // Тоггл: если активен — снять
  if(o.nsEffect[kind]) { o.nsEffect[kind] = false; } else {
    // Для текстов делаем возможность мульти-эффектов, но slide лучше эксклюзивный
    if(kind==='text-slide'){ o.nsEffect['text-slide']=true; o.nsEffect['text-fade']=false; }
    else o.nsEffect[kind] = true;
  }
  // Обновить подсветку кнопок
  document.querySelectorAll(`.effBtn[data-eff^="${kind.split('-')[0]}"]`).forEach(btn=>{
    const on = o.nsEffect[btn.dataset.eff];
    btn.classList.toggle('active', !!on);
  });
  App.canvas.renderAll(); pushHistory();
}

/** Тик-анимация */
function tick(ts){
  requestAnimationFrame(tick);
  if(!ts) return;
  const t = ts/1000; // секунды
  App.animClock = t;
  let needRender = false;
  App.canvas.getObjects().forEach(o=>{
    if(!o.nsEffect) return;
    if(o.nsEffect['text-fade'] && o.isType('textbox')){
      const a = (Math.sin(t*2)+1)/2; o.set('opacity', 0.6 + a*0.4); needRender = true;
    }
    if(o.nsEffect['text-pulse'] && o.isType('textbox')){
      const s = 1 + Math.sin(t*3)*0.05; o.scaleX = (o.scaleXBase||o.scaleX||1)*s; o.scaleY=(o.scaleYBase||o.scaleY||1)*s; o.dirty=true; needRender = true;
    }
    if(o.nsEffect['text-slide'] && o.nsType==='caption'){
      // мягкий подъём-вниз
      const y = Math.sin(t*2)*6; o.top = (o.topBase || o.top) + y; o.dirty=true; needRender=true;
    }
    if(o.nsEffect['obj-parallax'] && !o.isType('textbox')){
      const x = Math.sin(t*1.2)*12; o.left = (o.leftBase || o.left) + x; o.dirty=true; needRender=true;
    }
    if(o.nsEffect['obj-float'] && !o.isType('textbox')){
      const y = Math.sin(t*1.5)*10; o.top = (o.topBase || o.top) + y; o.dirty=true; needRender=true;
    }
    if(o.nsEffect['obj-zoom'] && !o.isType('textbox')){
      const s = 1 + Math.sin(t*1.8)*0.04; o.scaleX=(o.scaleXBase||o.scaleX||1)*s; o.scaleY=(o.scaleYBase||o.scaleY||1)*s; o.dirty=true; needRender=true;
    }
  });
  if(needRender && !App.isRecording) App.canvas.renderAll();
}

/* ---------- Лого pop-up ---------- */
function logoPop(){
  if(!App.logoObj) return;
  const o = App.logoObj;
  const base = { sx:o.scaleX, sy:o.scaleY };
  let t=0;
  const anim=()=>{
    t+=0.016; const s = base.sx * (0.85 + Math.min(1,t*3)*0.15);
    o.scaleX=s; o.scaleY= base.sy * (0.85 + Math.min(1,t*3)*0.15);
    App.canvas.renderAll();
    if(t<0.4) requestAnimationFrame(anim);
  };
  anim();
}

/* ---------- История (Undo/Redo) ---------- */
function pushHistory(silent){
  const now = Date.now();
  if(!silent && now - App.lastSaveTs < 350) return; // простая дебаунс-защита
  App.lastSaveTs = now;
  const slide = App.slides[App.currentSlide]; if(!slide) return;
  slide.history.push(JSON.stringify(App.canvas.toJSON(['nsType','nsEffect','excludeFromExport'])));
  if(slide.history.length>10) slide.history.shift();
  slide.redo = [];
}
function undo(){
  const slide = App.slides[App.currentSlide]; if(!slide || slide.history.length<2) return;
  const cur = slide.history.pop(); slide.redo.push(cur);
  const prev = slide.history[slide.history.length-1];
  App.canvas.loadFromJSON(JSON.parse(prev), ()=>{ App.canvas.renderAll(); buildLayerList(); });
}
function redo(){
  const slide = App.slides[App.currentSlide]; if(!slide || slide.redo.length===0) return;
  const state = slide.redo.pop(); slide.history.push(state);
  App.canvas.loadFromJSON(JSON.parse(state), ()=>{ App.canvas.renderAll(); buildLayerList(); });
}

/* ---------- Экспорт ---------- */
function exportPNG(){
  // временно скрываем оверлеи
  const vis = hideOverlaysForExport();
  const url = App.canvas.toDataURL({format:'png', quality:1});
  restoreOverlays(vis);
  download(url, `neurostep_${App.currentSlide+1}.png`);
}
async function exportWebM(){
  const sec = Math.max(3, Math.min(15, +document.getElementById('durationSec').value||8));
  const canvas = App.canvas.getElement();
  const stream = canvas.captureStream(30);
  const chunks = [];
  const rec = new MediaRecorder(stream, { mimeType: 'video/webm;codecs=vp9' });
  rec.ondataavailable = e=>{ if(e.data.size>0) chunks.push(e.data); };
  const vis = hideOverlaysForExport();
  App.isRecording = true;
  rec.start();
  await wait(sec*1000);
  rec.stop();
  await once(rec,'stop');
  App.isRecording = false;
  restoreOverlays(vis);
  const blob = new Blob(chunks, { type: 'video/webm' });
  const url = URL.createObjectURL(blob);
  download(url, `neurostep_${App.currentSlide+1}_${sec}s.webm`);
  URL.revokeObjectURL(url);
}
function hideOverlaysForExport(){
  const vis = { safe: App.safeLayer.visible, grid: App.gridLayer.visible };
  App.safeLayer.visible=false; App.gridLayer.visible=false; App.canvas.renderAll();
  return vis;
}
function restoreOverlays(vis){
  App.safeLayer.visible=vis.safe; App.gridLayer.visible=vis.grid; App.canvas.renderAll();
}
function wait(ms){ return new Promise(res=>setTimeout(res,ms)); }
function once(target, event){ return new Promise(res=>target.addEventListener(event,()=>res(),{once:true})); }
function download(url, name){
  const a = document.createElement('a'); a.href=url; a.download=name; a.click();
}

/* ---------- Порядок слоёв ---------- */
function buildLayerList(){
  const box = document.getElementById('layers'); box.innerHTML='';
  // показываем только пользовательские слои (без safe/grid)
  const objs = App.canvas.getObjects().filter(o=>!o.excludeFromExport);
  // сверху вниз — в UI хотим видеть "верхние" слои первыми
  objs.slice().reverse().forEach((o, idx)=>{
    const row = document.createElement('div'); row.className='layer-row';
    const h = document.createElement('div'); h.className='handle'; h.textContent='↕';
    const title = document.createElement('div'); title.textContent = layerName(o); title.className='tiny';
    const up = document.createElement('button'); up.className='btn ghost'; up.textContent='⬆️';
    const down = document.createElement('button'); down.className='btn ghost'; down.textContent='⬇️';
    up.onclick=()=>{ App.canvas.bringForward(o); App.canvas.renderAll(); buildLayerList(); pushHistory(); };
    down.onclick=()=>{ App.canvas.sendBackwards(o); App.canvas.renderAll(); buildLayerList(); pushHistory(); };
    row.onclick=(e)=>{ if(e.target===up||e.target===down) return; App.canvas.setActiveObject(o); App.canvas.requestRenderAll(); };
    row.append(h,title,up,down); box.append(row);
  });
}
function layerName(o){
  switch(o.nsType){
    case 'gradient': return 'Градиент';
    case 'mainImage': return 'Картинка';
    case 'png': return 'PNG-объект';
    case 'title': return 'Заголовок';
    case 'caption': return 'Caption';
    case 'logo': return 'Лого';
    default: return o.type;
  }
}

/* ---------- Превью слайдов ---------- */
function renderSlides(){
  const list = document.getElementById('slidesList'); list.innerHTML='';
  App.slides.forEach((s,i)=>{
    const item = document.createElement('div'); item.className='slide-item' + (i===App.currentSlide?' active':'');
    const th = document.createElement('div'); th.className='thumb';
    if(s.thumb){ const img = new Image(); img.src=s.thumb; img.style.maxWidth='100%'; img.style.maxHeight='100%'; th.innerHTML=''; th.append(img); }
    const info = document.createElement('div'); info.style.flex='1'; info.innerHTML = `<div>Слайд ${i+1}</div><div class="tiny">${App.W}×${App.H}</div>`;
    item.append(th, info);
    item.onclick=()=>{ saveCurrent(); App.currentSlide=i; loadSlide(i); renderSlides(); };
    list.append(item);
  });
}
function updateThumb(){
  if(!App.slides[App.currentSlide]) return;
  App.slides[App.currentSlide].thumb = App.canvas.toDataURL({format:'png',multiplier:0.2});
  renderSlides();
}

/* ---------- Меню расположения ---------- */
function bringFront(){ const o=App.canvas.getActiveObject(); if(!o) return; App.canvas.bringToFront(o); App.canvas.renderAll(); buildLayerList(); pushHistory(); }
function sendBack(){ const o=App.canvas.getActiveObject(); if(!o) return; App.canvas.sendToBack(o); App.canvas.renderAll(); buildLayerList(); pushHistory(); }

/* ---------- Привязка UI ---------- */
function bindUI(){
  // формат
  document.querySelectorAll('button[data-format]').forEach(b=>{
    b.onclick=()=>{
      const [w,h] = b.dataset.format.split('x').map(Number);
      scaleToFormat(w,h);
      updateThumb();
    };
  });
  // фон / градиент / изображения
  document.getElementById('bgFile').onchange=e=>{ const f=e.target.files?.[0]; if(f) loadBackground(f); e.target.value=''; };
  document.getElementById('bgColorBtn').onclick=()=>{ const c=prompt('HEX цвет фона (#RRGGBB), например #0b0b0b','#0b0b0b'); if(!c) return; App.canvas.setBackgroundColor(c, App.canvas.renderAll.bind(App.canvas)); pushHistory(); };
  const gradSel = document.getElementById('gradientPreset');
  gradSel.onchange=()=>applyGradient(gradSel.value, document.getElementById('gradientAboveBtn').classList.contains('active'));
  document.getElementById('gradientAboveBtn').onclick=(e)=>{ e.currentTarget.classList.toggle('active'); applyGradient(gradSel.value, e.currentTarget.classList.contains('active')); };

  document.getElementById('mainImgFile').onchange=e=>{ const f=e.target.files?.[0]; if(f) loadMainImage(f); e.target.value=''; };
  document.getElementById('pngFile').onchange=e=>{ const fs=[...e.target.files]; if(fs.length) addPngObjects(fs); e.target.value=''; };

  // текст
  document.getElementById('addTitle').onclick=addTitle;
  document.getElementById('addCaption').onclick=addCaption;
  ['fontFamily','fontColor','textSize'].forEach(id=>document.getElementById(id).oninput=applyTextProps);
  document.getElementById('textWidthPct').oninput=(e)=>{
    const o = App.canvas.getActiveObject(); if(!o || !o.isType('textbox')) return;
    const pct = +e.target.value; o.set({ width: App.W*pct/100 }); fitText(o); App.canvas.renderAll(); pushHistory();
  };
  document.querySelectorAll('.chip').forEach(ch=>{
    ch.onclick=()=>{ document.querySelectorAll('.chip').forEach(x=>x.classList.remove('active')); ch.classList.add('active'); applyTextPreset(ch.dataset.preset); };
  });

  // safe/grid
  document.getElementById('toggleSafe').onclick=(e)=>{ App.safeLayer.visible=!App.safeLayer.visible; e.currentTarget.classList.toggle('active', App.safeLayer.visible); App.canvas.renderAll(); };
  document.getElementById('toggleGrid').onclick=(e)=>{ App.gridLayer.visible=!App.gridLayer.visible; e.currentTarget.classList.toggle('active', App.gridLayer.visible); App.canvas.renderAll(); };

  // лого
  document.getElementById('logoFile').onchange=e=>{ const f=e.target.files?.[0]; if(f) loadLogo(f); e.target.value=''; };
  document.getElementById('logoPop').onclick=logoPop;

  // эффекты
  document.querySelectorAll('.effBtn').forEach(b=> b.onclick=()=>toggleEffect(b.dataset.eff));

  // история/слои
  document.getElementById('undoBtn').onclick=undo;
  document.getElementById('redoBtn').onclick=redo;
  document.getElementById('bringFront').onclick=bringFront;
  document.getElementById('sendBack').onclick=sendBack;

  // экспорт
  document.getElementById('exportPNG').onclick=exportPNG;
  document.getElementById('exportWebM').onclick=exportWebM;

  // слайды
  document.getElementById('addSlide').onclick=()=>newSlide();
  document.getElementById('dupSlide').onclick=dupCurrentSlide;
  document.getElementById('copyPrev').onclick=copyFromPrev;
  document.getElementById('prevSlide').onclick=prevSlide;
  document.getElementById('nextSlide').onclick=nextSlide;

  // события canvas -> история/слои
  App.canvas.on('object:added', e=>{ if(App.canvas.offRender) return; if(e?.target?.excludeFromExport) return; buildLayerList(); pushHistory(); });
  App.canvas.on('object:modified', ()=>{ buildLayerList(); pushHistory(); memorizeBases(); });
  App.canvas.on('object:removed', ()=>{ buildLayerList(); pushHistory(); });
  App.canvas.on('selection:created', syncEffectButtons);
  App.canvas.on('selection:updated', syncEffectButtons);
}
/** Синхронизировать подсветку кнопок эффектов */
function syncEffectButtons(){
  document.querySelectorAll('.effBtn').forEach(btn=>btn.classList.remove('active'));
  const o = App.canvas.getActiveObject(); if(!o||!o.nsEffect) return;
  Object.entries(o.nsEffect).forEach(([k,v])=>{
    if(v){ const btn = document.querySelector(`.effBtn[data-eff="${k}"]`); if(btn) btn.classList.add('active'); }
  });
}
/** Запоминаем базовые left/top/scale для мягких анимаций */
function memorizeBases(){
  App.canvas.getObjects().forEach(o=>{
    o.leftBase = o.left; o.topBase = o.top; o.scaleXBase=o.scaleX; o.scaleYBase=o.scaleY;
  });
}

/* ---------- Клавиатура ---------- */
document.addEventListener('keydown',(e)=>{
  if(e.ctrlKey && e.key.toLowerCase()==='z'){ e.preventDefault(); undo(); }
  if(e.ctrlKey && e.key.toLowerCase()==='y'){ e.preventDefault(); redo(); }
  if(e.key==='Delete'){ const o=App.canvas.getActiveObject(); if(o && !o.excludeFromExport){ App.canvas.remove(o); App.canvas.discardActiveObject(); App.canvas.renderAll(); pushHistory(); } }
});

/* ---------- Запуск ---------- */
init();
</script>
</body>
</html>