<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NeuroStep Redactor</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&family=Roboto:wght@400;700&family=Lato:wght@400;700&family=Oswald:wght@400;700&family=Raleway:wght@400;700&family=Inter:wght@400;700&family=Playfair+Display:wght@400;700&family=Source+Sans+Pro:wght@400;700&family=Noto+Sans:wght@400;700&family=DM+Sans:wght@400;700&family=Ubuntu:wght@400;700&family=Quicksand:wght@400;700&family=PT+Sans:wght@400;700&family=Teko:wght@400;700&family=Work+Sans:wght@400;700&family=Nunito:wght@400;700&family=Alegreya+Sans:wght@400;700&display=swap" rel="stylesheet">

  <!-- Fabric.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

  <style>
    body {margin:0;font-family:'Montserrat',sans-serif;background:#141e30;color:#fff;display:flex;flex-direction:column;height:100vh;}
    header {background:#111a2c;padding:12px;text-align:center;font-weight:bold;font-size:18px;box-shadow:0 2px 8px rgba(0,0,0,0.6);}
    main {flex:1;overflow-y:auto;padding:10px;}
    .card {background:rgba(255,255,255,0.05);border-radius:12px;padding:12px;margin-bottom:10px;}
    h2 {margin:0 0 8px;font-size:14px;}
    input,select,button {margin-top:6px;width:100%;padding:8px;border-radius:6px;border:none;font-size:13px;}
    button {background:linear-gradient(135deg,#5cc8ff,#a855f7);color:#fff;font-weight:bold;cursor:pointer;transition:0.2s;}
    button:active {transform:scale(0.97);}
    canvas {border:1px solid rgba(255,255,255,0.2);background:#000;display:block;margin:10px auto;}
  </style>
</head>
<body>
<header>üé® NeuroStep Redactor</header>
<main>
  <div class="card">
    <h2>–§–æ—Ä–º–∞—Ç —Ö–æ–ª—Å—Ç–∞</h2>
    <select id="canvasSize">
      <option value="1080x1080">–ü–æ—Å—Ç (1080√ó1080)</option>
      <option value="1080x1350" selected>–ö–∞—Ä—É—Å–µ–ª—å (1080√ó1350)</option>
      <option value="1080x1920">–°—Ç–æ—Ä–∏—Å/Reels (1080√ó1920)</option>
    </select>
    <button id="resizeCanvas">–ò–∑–º–µ–Ω–∏—Ç—å</button>
  </div>

  <div class="card">
    <h2>–§–æ–Ω –∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç</h2>
    <input type="file" id="bgUpload" accept="image/*" />
    <button id="bgBlack">–ß—ë—Ä–Ω—ã–π —Ñ–æ–Ω</button>
    <select id="gradientSelect">
      <option value="none">–ë–µ–∑ –≥—Ä–∞–¥–∏–µ–Ω—Ç–∞</option>
      <option value="black-up">–ß—ë—Ä–Ω—ã–π ‚Üí –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –≤–≤–µ—Ä—Ö</option>
      <option value="black-down">–ß—ë—Ä–Ω—ã–π ‚Üí –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π –≤–Ω–∏–∑</option>
      <option value="gray-dark">–°–µ—Ä—ã–π ‚Üí —Ç—ë–º–Ω–æ-—Å–µ—Ä—ã–π</option>
    </select>
    <button id="applyGradient">–î–æ–±–∞–≤–∏—Ç—å –≥—Ä–∞–¥–∏–µ–Ω—Ç</button>
  </div>

  <div class="card">
    <h2>–ö–∞—Ä—Ç–∏–Ω–∫–∞ –∏ PNG-–æ–±—ä–µ–∫—Ç—ã</h2>
    <input type="file" id="imgUpload" accept="image/*" />
    <input type="file" id="pngUpload" accept="image/*" />
    <label>–°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤</label>
    <input type="range" id="imgRadius" min="0" max="100" value="0">
  </div>

  <div class="card">
    <h2>–¢–µ–∫—Å—Ç</h2>
    <input type="text" id="titleText" placeholder="–ó–∞–≥–æ–ª–æ–≤–æ–∫">
    <input type="range" id="titleSize" min="20" max="120" value="64">
    <input type="text" id="captionText" placeholder="–ü–æ–¥–ø–∏—Å—å">
    <input type="range" id="captionSize" min="14" max="80" value="32">
    <label>–®—Ä–∏—Ñ—Ç</label><select id="fontSelect"></select>
    <label>–¶–≤–µ—Ç</label>
    <select id="colorSelect">
      <option value="#ffffff">–ë–µ–ª—ã–π</option>
      <option value="#000000">–ß—ë—Ä–Ω—ã–π</option>
      <option value="#FFD700">–ñ—ë–ª—Ç—ã–π</option>
    </select>
    <label>–°—Ç–∏–ª—å (–ø—Ä–µ—Å–µ—Ç)</label>
    <select id="stylePreset">
      <option value="boldwhite">–ë–µ–ª—ã–π bold —Å —Ç–µ–Ω—å—é</option>
      <option value="yellowglow">–ñ—ë–ª—Ç—ã–π glow</option>
      <option value="minimalblack">–ú–∏–Ω–∏–º–∞–ª —á—ë—Ä–Ω—ã–π</option>
    </select>
  </div>

  <div class="card">
    <h2>–≠—Ñ—Ñ–µ–∫—Ç—ã —Ç–µ–∫—Å—Ç–∞</h2>
    <button id="fadeText">Fade</button>
    <button id="pulseText">Pulse</button>
    <button id="slideCaption">Slide-in Caption</button>
  </div>

  <div class="card">
    <h2>–≠—Ñ—Ñ–µ–∫—Ç—ã –æ–±—ä–µ–∫—Ç–æ–≤</h2>
    <button id="parallaxObj">Parallax drift</button>
    <button id="floatObj">Float</button>
    <button id="zoomObj">Soft Zoom</button>
  </div>

  <div class="card">
    <h2>Safe-zones –∏ –±—Ä–µ–Ω–¥–∏–Ω–≥</h2>
    <button id="toggleSafe">–ü–æ–∫–∞–∑–∞—Ç—å/–°–∫—Ä—ã—Ç—å safe-zone</button>
    <input type="file" id="logoUpload" accept="image/*" />
  </div>

  <div class="card">
    <h2>–≠–∫—Å–ø–æ—Ä—Ç</h2>
    <button id="downloadPNG">‚¨áÔ∏è PNG</button>
    <button id="downloadWebM">‚¨áÔ∏è WebM (–∞–Ω–∏–º–∞—Ü–∏—è)</button>
  </div>

  <canvas id="c"></canvas>
</main>

<script>
const canvas = new fabric.Canvas('c',{preserveObjectStacking:true});
let bgImage, mainImage, titleObj, captionObj, gradientRect, logoObj, safeZone;
setCanvasSize(1080,1350);

function setCanvasSize(w,h){canvas.setWidth(w);canvas.setHeight(h);canvas.renderAll();}
document.getElementById('resizeCanvas').addEventListener('click',()=>{
  const [w,h]=document.getElementById('canvasSize').value.split("x").map(Number);
  setCanvasSize(w,h);
  if(bgImage){bgImage.set({width:w,height:h});canvas.sendToBack(bgImage);}
});

// –§–æ–Ω
document.getElementById('bgUpload').addEventListener('change',e=>{
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=f=>{fabric.Image.fromURL(f.target.result,img=>{
    img.scaleToWidth(canvas.width);img.scaleToHeight(canvas.height);
    if(bgImage) canvas.remove(bgImage);bgImage=img;bgImage.selectable=false;
    canvas.add(bgImage);canvas.sendToBack(bgImage);});};
  reader.readAsDataURL(file);
});
document.getElementById('bgBlack').addEventListener('click',()=>{
  if(bgImage) canvas.remove(bgImage);
  bgImage=new fabric.Rect({left:0,top:0,width:canvas.width,height:canvas.height,fill:"#000",selectable:false});
  canvas.add(bgImage);canvas.sendToBack(bgImage);
});

// –ì—Ä–∞–¥–∏–µ–Ω—Ç
document.getElementById('applyGradient').addEventListener('click',()=>{
  const type=document.getElementById('gradientSelect').value;
  if(gradientRect) canvas.remove(gradientRect);
  let grad;
  if(type==="black-up"){grad={x1:0,y1:canvas.height,x2:0,y2:0,colorStops:{0:"black",1:"transparent"}};}
  if(type==="black-down"){grad={x1:0,y1:0,x2:0,y2:canvas.height,colorStops:{0:"black",1:"transparent"}};}
  if(type==="gray-dark"){grad={x1:0,y1:0,x2:0,y2:canvas.height,colorStops:{0:"#444",1:"#111"}};}
  if(type!=="none"){gradientRect=new fabric.Rect({left:0,top:0,width:canvas.width,height:canvas.height,selectable:false});
    gradientRect.set("fill",new fabric.Gradient({type:"linear",...grad}));
    canvas.add(gradientRect);gradientRect.moveTo(1);}
});

// –û—Å–Ω–æ–≤–Ω–∞—è –∫–∞—Ä—Ç–∏–Ω–∫–∞
document.getElementById('imgUpload').addEventListener('change',e=>{
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=f=>{fabric.Image.fromURL(f.target.result,img=>{
    img.set({left:100,top:100});img.scaleToWidth(canvas.width/2);
    mainImage=img;canvas.add(mainImage);});};
  reader.readAsDataURL(file);
});
document.getElementById('imgRadius').addEventListener('input',e=>{
  if(mainImage){mainImage.set("rx",+e.target.value);mainImage.set("ry",+e.target.value);canvas.renderAll();}
});

// PNG-–æ–±—ä–µ–∫—Ç—ã
document.getElementById('pngUpload').addEventListener('change',e=>{
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=f=>{fabric.Image.fromURL(f.target.result,img=>{
    img.set({left:150,top:150,cornerStyle:'circle',cornerColor:'#5cc8ff'});
    img.scaleToWidth(canvas.width/4);canvas.add(img);canvas.setActiveObject(img);});};
  reader.readAsDataURL(file);
});

// Fonts
const fonts=["Montserrat","Poppins","Roboto","Lato","Oswald","Raleway","Inter","Playfair Display","Source Sans Pro","Noto Sans","DM Sans","Ubuntu","Quicksand","PT Sans","Teko","Work Sans","Nunito","Alegreya Sans"];
const fontSelect=document.getElementById('fontSelect');fonts.forEach(f=>{let o=document.createElement('option');o.value=f;o.innerText=f;fontSelect.appendChild(o);});
fontSelect.value="Montserrat";

// Texts
function updateTexts(){
  const font=fontSelect.value;const color=document.getElementById('colorSelect').value;const style=document.getElementById('stylePreset').value;
  let shadow;
  if(style==="boldwhite")shadow="2px 2px 6px rgba(0,0,0,0.8)";
  if(style==="yellowglow")shadow="0 0 10px rgba(255,200,0,0.9)";
  if(style==="minimalblack")shadow="1px 1px 3px rgba(0,0,0,0.6)";
  if(titleObj)canvas.remove(titleObj);
  if(captionObj)canvas.remove(captionObj);
  if(document.getElementById('titleText').value){
    titleObj=new fabric.Textbox(document.getElementById('titleText').value,{left:canvas.width/2,top:50,fontFamily:font,fill:color,fontSize:+document.getElementById('titleSize').value,originX:"center",shadow:shadow});canvas.add(titleObj);}
  if(document.getElementById('captionText').value){
    captionObj=new fabric.Textbox(document.getElementById('captionText').value,{left:canvas.width/2,top:canvas.height-100,fontFamily:font,fill:color,fontSize:+document.getElementById('captionSize').value,originX:"center",shadow:shadow,width:canvas.width-100});canvas.add(captionObj);}
}
["titleText","captionText","fontSelect","colorSelect","stylePreset","titleSize","captionSize"].forEach(id=>document.getElementById(id).addEventListener('input',updateTexts));

// Safe-zone
document.getElementById('toggleSafe').addEventListener('click',()=>{
  if(safeZone){canvas.remove(safeZone);safeZone=null;return;}
  safeZone=new fabric.Rect({left:0,top:0,width:canvas.width,height:150,fill:"rgba(255,0,0,0.2)",selectable:false});
  canvas.add(safeZone);canvas.bringToFront(safeZone);
});

// Logo
document.getElementById('logoUpload').addEventListener('change',e=>{
  const file=e.target.files[0];if(!file)return;
  const reader=new FileReader();
  reader.onload=f=>{fabric.Image.fromURL(f.target.result,img=>{
    img.scaleToWidth(100);img.set({left:canvas.width-120,top:canvas.height-120,opacity:0.5});
    logoObj=img;canvas.add(logoObj);});};
  reader.readAsDataURL(file);
});

// Text effects
document.getElementById('fadeText').addEventListener('click',()=>{if(titleObj){titleObj.animate('opacity',0.2,{duration:1000,onChange:canvas.renderAll.bind(canvas),onComplete:()=>{titleObj.animate('opacity',1,{duration:1000,onChange:canvas.renderAll.bind(canvas)});}});}});
document.getElementById('pulseText').addEventListener('click',()=>{if(titleObj){titleObj.animate('scaleX',1.1,{duration:500,onChange:canvas.renderAll.bind(canvas),onComplete:()=>{titleObj.animate('scaleX',1,{duration:500,onChange:canvas.renderAll.bind(canvas)});}});}});
document.getElementById('slideCaption').addEventListener('click',()=>{if(captionObj){captionObj.animate('top',captionObj.top-30,{duration:800,onChange:canvas.renderAll.bind(canvas),onComplete:()=>{captionObj.animate('top',captionObj.top+30,{duration:800,onChange:canvas.renderAll.bind(canvas)});}});}});

// Object effects
function animateObj(prop,val,obj){obj.animate(prop,val,{duration:1500,onChange:canvas.renderAll.bind(canvas),onComplete:()=>{obj.animate(prop,obj[prop]-val,{duration:1500,onChange:canvas.renderAll.bind(canvas)});}});}
document.getElementById('parallaxObj').addEventListener('click',()=>{const obj=canvas.getActiveObject();if(obj)animateObj('left',obj.left+20,obj);});
document.getElementById('floatObj').addEventListener('click',()=>{const obj=canvas.getActiveObject();if(obj)animateObj('top',obj.top+20,obj);});
document.getElementById('zoomObj').addEventListener('click',()=>{const obj=canvas.getActiveObject();if(obj){obj.animate('scaleX',obj.scaleX*1.1,{duration:1500,onChange:canvas.renderAll.bind(canvas),onComplete:()=>{obj.animate('scaleX',obj.scaleX/1.1,{duration:1500,onChange:canvas.renderAll.bind(canvas)});}});}});

// Export
document.getElementById('downloadPNG').addEventListener('click',()=>{
  const link=document.createElement('a');link.download="neurostep.png";link.href=canvas.toDataURL({format:'png'});link.click();
});
document.getElementById('downloadWebM').addEventListener('click',()=>{
  const stream=document.getElementById('c').captureStream(30);const rec=new MediaRecorder(stream,{mimeType:'video/webm'});let chunks=[];
  rec.ondataavailable=e=>{if(e.data.size>0)chunks.push(e.data);};
  rec.onstop=()=>{const blob=new Blob(chunks,{type:'video/webm'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download="neurostep.webm";a.click();};
  rec.start();setTimeout(()=>rec.stop(),5000);
});
</script>
</body>
</html>