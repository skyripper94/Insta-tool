<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Insta-tool Final</title>

  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&family=Poppins:wght@400;700&family=Roboto:wght@400;700&family=Lato:wght@400;700&family=Oswald:wght@400;700&family=Raleway:wght@400;700&family=Inter:wght@400;700&family=Playfair+Display:wght@400;700&family=Source+Sans+Pro:wght@400;700&family=Noto+Sans:wght@400;700&family=DM+Sans:wght@400;700&family=Ubuntu:wght@400;700&family=Quicksand:wght@400;700&family=PT+Sans:wght@400;700&family=Teko:wght@400;700&family=Work+Sans:wght@400;700&family=Nunito:wght@400;700&family=Alegreya+Sans:wght@400;700&display=swap" rel="stylesheet">

  <!-- Fabric.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Montserrat', sans-serif;
      background: linear-gradient(180deg,#141e30,#243b55);
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: #111a2c;
      padding: 14px;
      text-align: center;
      font-weight: bold;
      font-size: 18px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.6);
    }
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 10px;
      overflow-y: auto;
    }
    .card {
      background: rgba(255,255,255,0.05);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 10px;
      backdrop-filter: blur(6px);
    }
    h2 {
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 600;
    }
    input,select,button {
      margin-top: 6px;
      width: 100%;
      padding: 10px;
      border-radius: 8px;
      border: none;
      font-size: 14px;
    }
    button {
      background: linear-gradient(135deg,#5cc8ff,#a855f7);
      color: #fff;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }
    button:active { transform: scale(0.97); }
    canvas { border:1px solid rgba(255,255,255,0.2); background:#000; margin:10px auto; display:block; }
  </style>
</head>
<body>
<header>üì± Insta-tool Final</header>
<main>
  <div class="card">
    <h2>–§–æ—Ä–º–∞—Ç —Ö–æ–ª—Å—Ç–∞</h2>
    <select id="canvasSize">
      <option value="1080x1080">–ü–æ—Å—Ç (1080√ó1080)</option>
      <option value="1080x1350" selected>–ö–∞—Ä—É—Å–µ–ª—å (1080√ó1350)</option>
      <option value="1080x1920">–°—Ç–æ—Ä–∏—Å/Reels (1080√ó1920)</option>
    </select>
    <button id="resizeCanvas">–ò–∑–º–µ–Ω–∏—Ç—å —Ä–∞–∑–º–µ—Ä</button>
  </div>

  <div class="card">
    <h2>–§–æ–Ω</h2>
    <input type="file" id="bgUpload" accept="image/*" />
    <button id="bgBlack">–ß—ë—Ä–Ω—ã–π —Ñ–æ–Ω</button>
  </div>

  <div class="card">
    <h2>–ö–∞—Ä—Ç–∏–Ω–∫–∞</h2>
    <input type="file" id="imgUpload" accept="image/*" />
    <label>–°–∫—Ä—É–≥–ª–µ–Ω–∏–µ —É–≥–ª–æ–≤</label>
    <input type="range" id="imgRadius" min="0" max="100" value="0">
  </div>

  <div class="card">
    <h2>–¢–µ–∫—Å—Ç</h2>
    <label>–ó–∞–≥–æ–ª–æ–≤–æ–∫</label>
    <input type="text" id="titleText" placeholder="–í–≤–µ–¥–∏—Ç–µ –∑–∞–≥–æ–ª–æ–≤–æ–∫">
    <label>–ü–æ–¥–ø–∏—Å—å (Caption)</label>
    <input type="text" id="captionText" placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–¥–ø–∏—Å—å">
    <label>–®—Ä–∏—Ñ—Ç</label>
    <select id="fontSelect"></select>
    <label>–¶–≤–µ—Ç</label>
    <select id="colorSelect">
      <option value="#ffffff">–ë–µ–ª—ã–π</option>
      <option value="#000000">–ß—ë—Ä–Ω—ã–π</option>
      <option value="#FFD700">–ñ—ë–ª—Ç—ã–π</option>
    </select>
    <label>–¢–µ–Ω—å (–ø—Ä–µ—Å–µ—Ç)</label>
    <select id="shadowSelect">
      <option value="0 2 4 rgba(0,0,0,0.7)">–ß—ë—Ä–Ω–∞—è –≥–ª—É–±–æ–∫–∞—è</option>
      <option value="0 0 6 rgba(255,255,255,0.8)">–°–≤–µ—Ç–ª–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞</option>
      <option value="0 0 8 rgba(92,200,255,0.9)">–ù–µ–æ–Ω-—Å–∏–Ω–∏–π</option>
      <option value="0 0 10 rgba(168,85,247,0.9)">–§–∏–æ–ª–µ—Ç–æ–≤—ã–π glow</option>
      <option value="2 2 12 rgba(255,200,50,0.9)">–ñ—ë–ª—Ç–æ-–æ—Ä–∞–Ω–∂–µ–≤–∞—è</option>
    </select>
  </div>

  <div class="card">
    <h2>–≠—Ñ—Ñ–µ–∫—Ç—ã</h2>
    <button id="parallaxBtn">–ü–∞—Ä–∞–ª–ª–∞–∫—Å</button>
    <button id="kenburnsBtn">Ken Burns</button>
    <button id="fadeBtn">Fade —Ç–µ–∫—Å—Ç–∞</button>
  </div>

  <div class="card">
    <h2>–≠–∫—Å–ø–æ—Ä—Ç</h2>
    <button id="downloadPNG">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å PNG</button>
    <button id="downloadWebM">‚¨áÔ∏è –°–∫–∞—á–∞—Ç—å WebM (–∞–Ω–∏–º–∞—Ü–∏—è)</button>
  </div>

  <canvas id="c"></canvas>
</main>

<script>
const canvas = new fabric.Canvas('c',{preserveObjectStacking:true});
let bgImage, mainImage, titleObj, captionObj;

// === Init canvas size ===
function setCanvasSize(w,h){
  canvas.setWidth(w); canvas.setHeight(h); canvas.renderAll();
}
setCanvasSize(1080,1350);

// === Fonts ===
const fonts=["Montserrat","Poppins","Roboto","Lato","Oswald","Raleway","Inter","Playfair Display","Source Sans Pro","Noto Sans","DM Sans","Ubuntu","Quicksand","PT Sans","Teko","Work Sans","Nunito","Alegreya Sans"];
const fontSelect=document.getElementById('fontSelect');
fonts.forEach(f=>{
  const opt=document.createElement('option');
  opt.value=f; opt.innerText=f;
  fontSelect.appendChild(opt);
});
fontSelect.value="Montserrat";

// === Background ===
document.getElementById('bgUpload').addEventListener('change',e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=f=>{
    fabric.Image.fromURL(f.target.result,img=>{
      img.scaleToWidth(canvas.width);
      img.scaleToHeight(canvas.height);
      if(bgImage) canvas.remove(bgImage);
      bgImage=img; bgImage.selectable=false;
      canvas.add(bgImage); bgImage.moveTo(0); canvas.sendToBack(bgImage);
    });
  };
  reader.readAsDataURL(file);
});
document.getElementById('bgBlack').addEventListener('click',()=>{
  if(bgImage) canvas.remove(bgImage);
  bgImage=new fabric.Rect({left:0,top:0,width:canvas.width,height:canvas.height,fill:"#000",selectable:false});
  canvas.add(bgImage); canvas.sendToBack(bgImage);
});

// === Main Image ===
document.getElementById('imgUpload').addEventListener('change',e=>{
  const file=e.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=f=>{
    fabric.Image.fromURL(f.target.result,img=>{
      img.set({left:100,top:100,cornerStyle:'circle',cornerColor:'#5cc8ff'});
      img.scaleToWidth(canvas.width/2);
      mainImage=img; canvas.add(mainImage); canvas.setActiveObject(mainImage);
    });
  };
  reader.readAsDataURL(file);
});
document.getElementById('imgRadius').addEventListener('input',e=>{
  if(mainImage){
    mainImage.set('rx',+e.target.value);
    mainImage.set('ry',+e.target.value);
    canvas.renderAll();
  }
});

// === Texts ===
function applyText(){
  const titleVal=document.getElementById('titleText').value;
  const captionVal=document.getElementById('captionText').value;
  const font=fontSelect.value;
  const color=document.getElementById('colorSelect').value;
  const shadowPreset=document.getElementById('shadowSelect').value.split(" ");
  const sx=+shadowPreset[0], sy=+shadowPreset[1], blur=+shadowPreset[2], colorShadow=shadowPreset.slice(3).join(" ");

  if(titleObj) canvas.remove(titleObj);
  if(captionObj) canvas.remove(captionObj);

  if(titleVal){
    titleObj=new fabric.Textbox(titleVal,{left:50,top:50,fontFamily:font,fill:color,fontSize:64,shadow:{color:colorShadow,blur:blur,offsetX:sx,offsetY:sy}});
    canvas.add(titleObj);
  }
  if(captionVal){
    captionObj=new fabric.Textbox(captionVal,{left:50,top:150,fontFamily:font,fill:color,fontSize:32,shadow:{color:colorShadow,blur:blur,offsetX:sx,offsetY:sy}});
    canvas.add(captionObj);
  }
}
document.getElementById('titleText').addEventListener('input',applyText);
document.getElementById('captionText').addEventListener('input',applyText);
fontSelect.addEventListener('change',applyText);
document.getElementById('colorSelect').addEventListener('change',applyText);
document.getElementById('shadowSelect').addEventListener('change',applyText);

// === Canvas Resize ===
document.getElementById('resizeCanvas').addEventListener('click',()=>{
  const val=document.getElementById('canvasSize').value;
  const [w,h]=val.split("x").map(Number);
  setCanvasSize(w,h);
  if(bgImage){
    bgImage.set({width:w,height:h}); canvas.sendToBack(bgImage);
  }
});

// === Effects ===
function runEffect(type){
  let duration=5000; // 5s
  if(type==="parallax"){
    let anim=()=>{ if(mainImage){
      mainImage.animate('left',mainImage.left+20,{duration:duration/2,onChange:canvas.renderAll.bind(canvas),onComplete:()=>{
        mainImage.animate('left',mainImage.left-20,{duration:duration/2,onChange:canvas.renderAll.bind(canvas)});
      }});
    }};
    anim();
  }
  if(type==="kenburns"){
    if(mainImage){
      mainImage.animate('scaleX',mainImage.scaleX*1.1,{duration:duration,onChange:canvas.renderAll.bind(canvas)});
      mainImage.animate('scaleY',mainImage.scaleY*1.1,{duration:duration,onChange:canvas.renderAll.bind(canvas)});
      mainImage.animate('top',mainImage.top-30,{duration:duration,onChange:canvas.renderAll.bind(canvas)});
    }
  }
  if(type==="fade" && titleObj){
    titleObj.animate('opacity',0.2,{duration:duration/2,onChange:canvas.renderAll.bind(canvas),onComplete:()=>{
      titleObj.animate('opacity',1,{duration:duration/2,onChange:canvas.renderAll.bind(canvas)});
    }});
  }
}
document.getElementById('parallaxBtn').addEventListener('click',()=>runEffect("parallax"));
document.getElementById('kenburnsBtn').addEventListener('click',()=>runEffect("kenburns"));
document.getElementById('fadeBtn').addEventListener('click',()=>runEffect("fade"));

// === Export PNG ===
document.getElementById('downloadPNG').addEventListener('click',()=>{
  const link=document.createElement('a');
  link.download="insta-tool.png";
  link.href=canvas.toDataURL({format:'png'});
  link.click();
});

// === Export WebM (simple simulation) ===
document.getElementById('downloadWebM').addEventListener('click',()=>{
  const stream=document.getElementById('c').captureStream(30);
  const rec=new MediaRecorder(stream,{mimeType:'video/webm'});
  let chunks=[];
  rec.ondataavailable=e=>{ if(e.data.size>0) chunks.push(e.data); };
  rec.onstop=()=>{
    const blob=new Blob(chunks,{type:'video/webm'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download="insta-tool.webm"; a.click();
  };
  rec.start();
  runEffect("parallax");
  setTimeout(()=>rec.stop(),5000); // 5s –∑–∞–ø–∏—Å—å
});
</script>
</body>
</html>