<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>NeuroStep Redactor</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;900&display=swap" rel="stylesheet">
  <style>
    body { margin:0; font:14px "Montserrat",sans-serif; background:#0a0f20; color:#fff;
           display:flex; height:100vh; overflow:hidden; gap:12px; padding:12px; }
    aside { width:340px; background:#151a2e; padding:12px; border-radius:12px; overflow:auto; transition:transform 0.3s ease; }
    main { flex:1; display:flex; gap:12px; }
    .stage { flex:1; display:flex; align-items:center; justify-content:center; background:#0c1124;
             border-radius:12px; border:1px solid #333; }
    canvas { background:#111728; border-radius:10px; }
    .btn { padding:6px 10px; border:1px solid #333; background:#0b1123; border-radius:6px;
           cursor:pointer; font-size:13px; color:#fff; }
    .btn:hover { border-color:#666; }
    .btn.primary { background:linear-gradient(90deg,#6ae1ff,#9b6bff); color:#000; font-weight:700; }
    .row { display:flex; gap:12px; margin:8px 0; flex-wrap:wrap; }
    .btn.active { outline:2px solid #6ae1ff; }
    .hint { font-size:11px; color:#aaa; margin-top:2px; max-width:100px; }
    .toggle-menu { display:none; }

    @media (max-width:768px) {
      aside {
        position: fixed;
        top: 0; left: 0; bottom: 0;
        width: 80vw;
        max-width: 320px;
        transform: translateX(-100%);
        z-index: 100;
      }
      aside.open { transform: translateX(0); }
      .toggle-menu {
        display:block;
        position: fixed;
        top:10px; left:10px;
        background:#0b1123; color:#fff; border:1px solid #333;
        padding:6px 10px; border-radius:6px; cursor:pointer; z-index:200;
      }
      main { flex:1; }
    }
  </style>
</head>
<body>
  <button class="toggle-menu">☰</button>
  <aside>
    <h1>NeuroStep Redactor</h1>
    <div class="hint">Редактор для Instagram-каруселей</div>

    <h2>Фон</h2>
    <div class="row">
      <button id="blackBg" class="btn">Чёрный фон</button>
      <label class="btn"><input id="bgPhoto" type="file" accept="image/*">Фото как фон</label>
    </div>

    <h2>Текст</h2>
    <div class="row"><button id="addTitle" class="btn">Заголовок</button></div>
    <div class="row"><button id="addCaption" class="btn">Caption</button></div>

    <h2>Эффекты: Текст</h2>
    <div class="row">
      <div><button class="btn textEffBtn" data-eff="fade">Fade-in</button><div class="hint">Для заголовков</div></div>
      <div><button class="btn textEffBtn" data-eff="slide">Slide-up</button><div class="hint">Для caption</div></div>
      <div><button class="btn textEffBtn" data-eff="pulse">Pulse</button><div class="hint">Акцентные слова</div></div>
    </div>

    <h2>Эффекты: Объекты</h2>
    <div class="row">
      <div><button class="btn effBtn" data-eff="parallax">Parallax</button><div class="hint">Фоновые элементы</div></div>
      <div><button class="btn effBtn" data-eff="float">Float</button><div class="hint">PNG-объекты</div></div>
      <div><button class="btn effBtn" data-eff="zoom">Zoom</button><div class="hint">Главная картинка</div></div>
    </div>
    <div class="row">
      <div><button class="btn effBtn" data-eff="glow">Glow</button><div class="hint">Декоративные круги</div></div>
      <div><button class="btn effBtn" data-eff="tilt">Tilt</button><div class="hint">Логотип</div></div>
      <div><button class="btn effBtn" data-eff="grain">Grain</button><div class="hint">Фон (плёнка)</div></div>
    </div>

    <h2>Разметка</h2>
    <div class="row">
      <button id="toggleSafe" class="btn">Safe Zones</button>
      <button id="toggleGrid" class="btn">Сетка</button>
    </div>
    <h2>Настройки разметки</h2>
    <div class="row"><label>Safe Opacity <input id="safeOpacity" type="range" min="0.1" max="0.8" step="0.1" value="0.2"></label></div>
    <div class="row"><label>Safe Color <input id="safeColor" type="color" value="#ff0000"></label></div>
    <div class="row"><label>Grid Thickness <input id="gridThick" type="range" min="1" max="5" step="1" value="1"></label></div>
    <div class="row"><label>Grid Color <input id="gridColor" type="color" value="#ffffff"></label></div>

    <h2>История</h2>
    <div class="row"><button id="undoBtn" class="btn">⬅️</button><button id="redoBtn" class="btn">➡️</button></div>

    <h2>Экспорт</h2>
    <div class="row"><button id="exportPNG" class="btn primary">PNG</button><button id="exportJPG" class="btn primary">JPEG</button></div>
    <div class="row"><input id="duration" type="number" min="3" max="15" value="8" style="width:80px"><button id="exportWebM" class="btn primary">WebM</button></div>
  </aside>

  <main>
    <div class="stage"><canvas id="cvs"></canvas></div>
  </main>

<script>
const App={canvas:null,W:1080,H:1350,history:[],redo:[],animating:false};
let safeZones=null, gridLines=null;
let safeOpacity=0.2, safeColor="#ff0000", gridThick=1, gridColor="#ffffff";

function init(){
  App.canvas=new fabric.Canvas('cvs',{preserveObjectStacking:true});
  setFormat(1080,1350);

  const saved=localStorage.getItem("ns_project");
  if(saved){ App.canvas.loadFromJSON(saved,()=>App.canvas.renderAll()); }

  App.canvas.on('object:modified',()=>{addHistory();saveProject();});
  App.canvas.on('object:added',()=>{addHistory();saveProject();});
  App.canvas.on('object:removed',()=>{addHistory();saveProject();});

  requestAnimationFrame(tick);

  // эффекты
  document.querySelectorAll('.effBtn').forEach(btn=>{
    btn.onclick=()=>{
      const eff=btn.dataset.eff;
      const obj=App.canvas.getActiveObject();
      if(!obj) return;
      if(obj.nsEffect===eff){ obj.nsEffect=null; btn.classList.remove('active'); }
      else{ obj.nsEffect=eff; updateEffectButtons(); }
      App.canvas.renderAll();
    };
  });
  document.querySelectorAll('.textEffBtn').forEach(btn=>{
    btn.onclick=()=>{
      const eff=btn.dataset.eff;
      const obj=App.canvas.getActiveObject();
      if(!obj || obj.type!=="textbox") return;
      if(obj.nsTextEffect===eff){ obj.nsTextEffect=null; btn.classList.remove('active'); }
      else{ obj.nsTextEffect=eff; updateTextEffectButtons(); }
      App.canvas.renderAll();
    };
  });

  App.canvas.on('selection:created',()=>{updateEffectButtons();updateTextEffectButtons();});
  App.canvas.on('selection:updated',()=>{updateEffectButtons();updateTextEffectButtons();});
  App.canvas.on('selection:cleared',()=>{
    document.querySelectorAll('.effBtn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.textEffBtn').forEach(b=>b.classList.remove('active'));
  });

  // мобильное меню
  document.querySelector('.toggle-menu').onclick=()=>{
    document.querySelector('aside').classList.toggle('open');
  };

  // safe zones
  document.getElementById('toggleSafe').onclick=()=>{
    if(safeZones){ App.canvas.remove(safeZones); safeZones=null; }
    else {
      safeZones=new fabric.Group([
        new fabric.Rect({left:0,top:0,width:App.W,height:120,fill:hexToRgba(safeColor,safeOpacity),selectable:false,evented:false}),
        new fabric.Rect({left:0,top:App.H-200,width:App.W,height:200,fill:hexToRgba(safeColor,safeOpacity),selectable:false,evented:false})
      ], {selectable:false,evented:false});
      App.canvas.add(safeZones); App.canvas.sendToBack(safeZones);
    }
    App.canvas.renderAll();
  };

  // grid
  document.getElementById('toggleGrid').onclick=()=>{
    if(gridLines){ gridLines.forEach(l=>App.canvas.remove(l)); gridLines=null; }
    else {
      gridLines=[];
      [App.W/3, 2*App.W/3].forEach(x=>{
        let l=new fabric.Line([x,0,x,App.H],{stroke:gridColor,strokeWidth:gridThick,selectable:false,evented:false});
        App.canvas.add(l); gridLines.push(l);
      });
      [App.H/3, 2*App.H/3].forEach(y=>{
        let l=new fabric.Line([0,y,App.W,y],{stroke:gridColor,strokeWidth:gridThick,selectable:false,evented:false});
        App.canvas.add(l); gridLines.push(l);
      });
    }
    App.canvas.renderAll();
  };

  // настройки
  document.getElementById('safeOpacity').oninput=e=>{
    safeOpacity=parseFloat(e.target.value);
    if(safeZones){
      safeZones._objects[0].set({fill:hexToRgba(safeColor,safeOpacity)});
      safeZones._objects[1].set({fill:hexToRgba(safeColor,safeOpacity)});
      App.canvas.renderAll();
    }
  };
  document.getElementById('safeColor').oninput=e=>{
    safeColor=e.target.value;
    if(safeZones){
      safeZones._objects[0].set({fill:hexToRgba(safeColor,safeOpacity)});
      safeZones._objects[1].set({fill:hexToRgba(safeColor,safeOpacity)});
      App.canvas.renderAll();
    }
  };
  document.getElementById('gridThick').oninput=e=>{
    gridThick=parseInt(e.target.value);
    if(gridLines){ gridLines.forEach(l=>l.set({strokeWidth:gridThick})); App.canvas.renderAll(); }
  };
  document.getElementById('gridColor').oninput=e=>{
    gridColor=e.target.value;
    if(gridLines){ gridLines.forEach(l=>l.set({stroke:gridColor})); App.canvas.renderAll(); }
  };
}

function setFormat(w,h){ App.W=w;App.H=h; App.canvas.setWidth(w);App.canvas.setHeight(h); }

function updateEffectButtons(){
  const obj=App.canvas.getActiveObject();
  document.querySelectorAll('.effBtn').forEach(b=>{
    if(obj && obj.nsEffect===b.dataset.eff) b.classList.add('active');
    else b.classList.remove('active');
  });
}
function updateTextEffectButtons(){
  const obj=App.canvas.getActiveObject();
  document.querySelectorAll('.textEffBtn').forEach(b=>{
    if(obj && obj.nsTextEffect===b.dataset.eff) b.classList.add('active');
    else b.classList.remove('active');
  });
}

// ===== история =====
function addHistory(){ App.history.push(App.canvas.toJSON()); if(App.history.length>20) App.history.shift(); App.redo=[]; }
function undo(){ if(App.history.length>1){ const s=App.history.splice(App.history.length-2,1)[0]; App.redo.push(App.canvas.toJSON()); App.canvas.loadFromJSON(s,()=>App.canvas.renderAll()); saveProject(); } }
function redo(){ if(App.redo.length>0){ const s=App.redo.pop(); App.history.push(s); App.canvas.loadFromJSON(s,()=>App.canvas.renderAll()); saveProject(); } }

// ===== сохранение =====
function saveProject(){ localStorage.setItem("ns_project",JSON.stringify(App.canvas.toJSON())); }

// ===== эффекты =====
function tick(){
  const t=Date.now()/1000;
  App.canvas.getObjects().forEach(o=>{
    if(o.nsEffect){
      if(o.nsEffect==="parallax"){ o.left+=(Math.sin(t)/50); o.top+=(Math.cos(t)/50); }
      if(o.nsEffect==="float"){ o.top+=(Math.sin(t*2)/100); }
      if(o.nsEffect==="zoom"){ o.scaleX=1+Math.sin(t)/100; o.scaleY=o.scaleX; }
      if(o.nsEffect==="glow"){ o.shadow=`rgba(255,255,255,${0.3+0.2*Math.sin(t*3)}) 0 0 20px`; }
      if(o.nsEffect==="tilt"){ o.angle=2*Math.sin(t*1.5); }
      if(o.nsEffect==="grain"){ o.opacity=0.9+0.05*Math.sin(t*5); }
    }
    if(o.nsTextEffect){
      if(o.nsTextEffect==="fade"){ o.opacity=0.5+0.5*Math.sin(t*2); }
      if(o.nsTextEffect==="slide"){ o.top+=Math.sin(t*2)/2; }
      if(o.nsTextEffect==="pulse"){ o.scaleX=1+Math.sin(t*3)/20; o.scaleY=o.scaleX; }
    }
  });
  if(App.animating) App.canvas.renderAll();
  requestAnimationFrame(tick);
}

// ===== вспомогательные =====
function hexToRgba(hex, alpha){
  const r=parseInt(hex.slice(1,3),16);
  const g=parseInt(hex.slice(3,5),16);
  const b=parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${alpha})`;
}

// ===== UI =====
document.getElementById('blackBg').onclick=()=>{
  const rect=new fabric.Rect({left:0,top:0,width:App.W,height:App.H,fill:'#000'});
  App.canvas.add(rect); App.canvas.sendToBack(rect); addHistory(); saveProject();
};
document.getElementById('bgPhoto').onchange=e=>{
  const f=e.target.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=()=>fabric.Image.fromURL(r.result,img=>{
    img.scaleToWidth(App.W); img.scaleToHeight(App.H);
    img.set({left:0,top:0}); App.canvas.add(img); App.canvas.sendToBack(img);
    App.canvas.renderAll(); addHistory(); saveProject();
  });
  r.readAsDataURL(f);
};
document.getElementById('addTitle').onclick=()=>{
  const t=new fabric.Textbox("Заголовок",{left:App.W/2,top:100,fontSize:64,fill:"#fff",originX:"center"});
  App.canvas.add(t); addHistory(); saveProject();
};
document.getElementById('addCaption').onclick=()=>{
  const t=new fabric.Textbox("Caption",{left:App.W/2,top:App.H-100,fontSize:32,fill:"#fff",originX:"center"});
  App.canvas.add(t); addHistory(); saveProject();
};
document.getElementById('undoBtn').onclick=undo;
document.getElementById('redoBtn').onclick=redo;

// ===== экспорт =====
document.getElementById('exportPNG').onclick=()=>{
  const url=App.canvas.toDataURL({format:'png'});
  const a=document.createElement('a'); a.href=url; a.download='slide.png'; a.click();
};
document.getElementById('exportJPG').onclick=()=>{
  const url=App.canvas.toDataURL({format:'jpeg',quality:0.9});
  const a=document.createElement('a'); a.href=url; a.download='slide.jpg'; a.click();
};
document.getElementById('exportWebM').onclick=()=>{
  const duration=parseInt(document.getElementById('duration').value)||8;
  const canvasEl=document.getElementById('cvs');
  const stream=canvasEl.captureStream(30);
  const rec=new MediaRecorder(stream,{mimeType:'video/webm;codecs=vp9'});
  const chunks=[];
  rec.ondataavailable=e=>chunks.push(e.data);
  rec.onstop=()=>{
    const blob=new Blob(chunks,{type:'video/webm'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a'); a.href=url; a.download='slide.webm'; a.click();
  };
  App.animating=true;
  rec.start();
  setTimeout(()=>{rec.stop();App.animating=false;},duration*1000);
};

init();
</script>
</body>
</html>